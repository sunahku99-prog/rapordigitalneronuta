"use strict";(()=>{var e={};e.id=366,e.ids=[366],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},41541:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>_,runtime:()=>c});var a=r(49303),i=r(88716),s=r(60670),o=r(87070),u=r(90455),l=r(97220),p=r(53524),d=r(17701);let c="nodejs",m=new p.PrismaClient;async function _(e){let t=(0,u.WX)(e.headers.get("authorization")||void 0);if(!t||!(0,u.Iq)([l.K.ADMIN,l.K.WALI_KELAS],t.role))return o.NextResponse.json({message:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),n=Number(r.get("classId")),a=Number(r.get("semester")||1),i=String(r.get("tahun")||"2024/2025"),s=await m.class.findUnique({where:{id:n}});if(!s)return o.NextResponse.json({message:"Kelas tidak ditemukan"},{status:404});let p=await m.student.findMany({where:{classId:n},include:{user:!0}}),c=await m.grade.findMany({where:{semester:a,year:i,type:"RAPOR",studentId:{in:p.map(e=>e.id)}},include:{subject:!0}}),_=Array.from(new Set(c.map(e=>e.subject.name))).sort(),f=new Map;c.forEach(e=>{f.set(`${e.studentId}|${e.subject.name}`,e.value)});let h=process.env.SCHOOL_NAME||"SMP Negeri 2 Ngunut",g=(0,d.y)(e=>{e.fontSize(14).text(`Leger Nilai - ${s.name}`,{align:"center"}),e.fontSize(10).text(`Sekolah: ${h}`,{align:"center"}),e.fontSize(10).text(`Tahun/Semester: ${i} / ${a}`,{align:"center"}),e.moveDown();let t=["No","Nama Siswa","NISN",..._],r=[30,150,80],n=540-r.reduce((e,t)=>e+t,0),o=_.length?Math.max(50,Math.floor(n/_.length)):60,u=[...r,..._.map(()=>o)],l=p.map((e,t)=>{let r=_.map(t=>f.get(`${e.id}|${t}`)??"-");return[t+1,e.user.name,e.nisn,...r]});(function(e,t,r,n,a,i){e.fontSize(9);let s=36,o=r;n.forEach((t,r)=>{e.rect(s,o,i[r],18).stroke(),e.text(t,s+4,o+4,{width:i[r]-8}),s+=i[r]}),o+=18,a.forEach(t=>{s=36,t.forEach((t,r)=>{e.rect(s,o,i[r],18).stroke(),e.text(String(t??"-"),s+4,o+4,{width:i[r]-8}),s+=i[r]}),o+=18})})(e,0,e.y,t,l,u),e.moveDown(2);let d=e.y;e.fontSize(10).text("Wali Kelas",36,d),e.fontSize(10).text("Kepala Sekolah",420,d),e.text("__________________",36,d+60),e.text("__________________",420,d+60)});return new o.NextResponse(g,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="leger_${s.name}_${a}.pdf"`}})}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/leger/pdf/route",pathname:"/api/leger/pdf",filename:"route",bundlePath:"app/api/leger/pdf/route"},resolvedPagePath:"D:\\rapor-digital\\rapor-digital\\app\\api\\leger\\pdf\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:x}=f,w="/api/leger/pdf/route";function S(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},90455:(e,t,r)=>{r.d(t,{BN:()=>p,Iq:()=>m,VU:()=>l,WX:()=>c,cG:()=>d});var n=r(41482),a=r.n(n),i=r(42023),s=r.n(i);let o=new(r(53524)).PrismaClient,u=process.env.JWT_SECRET;async function l(e,t){let r=await o.user.findUnique({where:{email:e}});return r&&await s().compare(t,r.passwordHash)?r:null}async function p(e,t){let r=await o.student.findUnique({where:{nisn:e},include:{user:!0}});return r&&"SISWA"===r.user.role&&await s().compare(t,r.user.passwordHash)?r.user:null}function d(e){return a().sign({sub:e.id,role:e.role,name:e.name,email:e.email},u,{expiresIn:"8h"})}function c(e){if(!e)return null;let t=e.replace("Bearer ","");try{let e=a().verify(t,u);return{userId:Number(e.sub),role:e.role}}catch{return null}}function m(e,t){return t&&e.includes(t)}},17701:(e,t,r)=>{r.d(t,{y:()=>i});var n=r(61245),a=r(76162);function i(e){let t=new a.PassThrough,r=new n.Z({size:"A4",margin:36});return r.pipe(t),e(r),r.end(),t}},97220:(e,t,r)=>{r.d(t,{K:()=>a});var n=r(53524);let a={ADMIN:n.Role.ADMIN,GURU:n.Role.GURU,WALI_KELAS:n.Role.WALI_KELAS,SISWA:n.Role.SISWA,ORANG_TUA:n.Role.ORANG_TUA}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,644,245],()=>r(41541));module.exports=n})();